# Bibliothèque de flux, d'impression dans stdout.

fonction externe printf(fmt : *z8, args : ...) : z32;
fonction externe sprintf(tmp : *z8, fmt : *z8, args : ...) : z32;
fonction externe open(chemin : *z8, oflag : z32) : z32;
fonction externe close(filedes : z32) : z32;
fonction externe read(filedes : z32, tpn : *z8, nbyte : z64) : z32;
fonction externe write(filedes : z32, tpn : *z8, nbyte : z64) : z32;

fonction imprime_valeur_membre(pointeur : *z8, info : *InfoType) : rien
{
    dyn tmp : [128]z8;
    dyn ptr_tmp = @tmp[0];

    dyn ecrie = 0;

    si id de info == TYPE_ENTIER {
        soit info_arg = transtype(info : *InfoTypeEntier);

        si est_signe de info_arg {
            si taille_en_octet de info_arg == 8 {
                soit x : z8 = mémoire(transtype(pointeur : *z8));
                ecrie = sprintf(ptr_tmp, "%c", x);
            }
            sinon si taille_en_octet de info_arg == 16 {
                soit x : z16 = mémoire(transtype(pointeur : *z16));
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 32 {
                soit x : z32 = mémoire(transtype(pointeur : *z32));
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 64 {
                soit x : z64 = mémoire(transtype(pointeur : *z64));
                ecrie = sprintf(ptr_tmp, "%ld", x);
            }
        }
        sinon {
            si taille_en_octet de info_arg == 8 {
                soit x : n8 = mémoire(transtype(pointeur : *n8));
                ecrie = sprintf(ptr_tmp, "%c", x);
            }
            sinon si taille_en_octet de info_arg == 16 {
                soit x : n16 = mémoire(transtype(pointeur : *n16));
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 32 {
                soit x : n32 = mémoire(transtype(pointeur : *n32));
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 64 {
                soit x : n64 = mémoire(transtype(pointeur : *n64));
                ecrie = sprintf(ptr_tmp, "%ld", x);
            }
        }
    }
    sinon si id de info == TYPE_REEL {
        # À FAIRE
        soit info_arg = transtype(info : *InfoTypeReel);

        si taille_en_octet de info_arg == 16 {
            soit x : r16 = mémoire(transtype(pointeur : *r16));
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
        sinon si taille_en_octet de info_arg == 32 {
            soit x : r32 = mémoire(transtype(pointeur : *r32));
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
        sinon si taille_en_octet de info_arg == 64 {
            soit x : r64 = mémoire(transtype(pointeur : *r64));
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
    }
    sinon si id de info == TYPE_BOOLEEN {
        # À FAIRE
    }
    sinon si id de info == TYPE_CHAINE {
        # À FAIRE
        soit x : chaîne = mémoire(transtype(pointeur : *chaîne));
        ecrie = sprintf(ptr_tmp, "chaîne { ptr = %p, taille = %d }", pointeur de x, taille de x);
    }
    sinon si id de info == TYPE_STRUCTURE {
        # À FAIRE
    }
    sinon si id de info == TYPE_POINTEUR {
        # Ne pas oublier qu'il y a un niveau d'indirection.
        soit x = transtype(pointeur : **z8);
        soit x0 = mémoire(x);
        ecrie = sprintf(ptr_tmp, "%p", x0);
    }
    sinon si id de info == TYPE_FONCTION {
        # À FAIRE
    }
    sinon si id de info == TYPE_EINI {
        # À FAIRE
    }
    sinon si id de info == TYPE_RIEN {
        # À FAIRE
    }
        
    write(0, ptr_tmp, transtype(ecrie : z64));
}

fonction imprime_arg(arg : eini) : rien
{
    dyn tmp : [1024]z8;
    dyn ptr_tmp = @tmp[0];

    dyn ecrie = 0;

    soit info = info de arg;

    si id de info == TYPE_ENTIER {
        soit info_arg = transtype(info : *InfoTypeEntier);

        si est_signe de info_arg {
            si taille_en_octet de info_arg == 8 {
                soit x : z8 = arg;
                ecrie = sprintf(ptr_tmp, "%c", x);
            }
            sinon si taille_en_octet de info_arg == 16 {
                soit x : z16 = arg;
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 32 {
                soit x : z32 = arg;
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 64 {
                soit x : z64 = arg;
                ecrie = sprintf(ptr_tmp, "%ld", x);
            }
        }
        sinon {
            si taille_en_octet de info_arg == 8 {
                soit x : n8 = arg;
                ecrie = sprintf(ptr_tmp, "%c", x);
            }
            sinon si taille_en_octet de info_arg == 16 {
                soit x : n16 = arg;
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 32 {
                soit x : n32 = arg;
                ecrie = sprintf(ptr_tmp, "%d", x);
            }
            sinon si taille_en_octet de info_arg == 64 {
                soit x : n64 = arg;
                ecrie = sprintf(ptr_tmp, "%ld", x);
            }
        }
    }
    sinon si id de info == TYPE_REEL {
        soit info_arg = transtype(info : *InfoTypeReel);

        si taille_en_octet de info_arg == 16 {
            soit x : r16 = arg;
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
        sinon si taille_en_octet de info_arg == 32 {
            soit x : r32 = arg;
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
        sinon si taille_en_octet de info_arg == 64 {
            soit x : r64 = arg;
            ecrie = sprintf(ptr_tmp, "%f", x);
        }
    }
    sinon si id de info == TYPE_BOOLEEN {
        soit x : bool = arg;
        ecrie = sprintf(ptr_tmp, "%d", x);
    }
    sinon si id de info == TYPE_CHAINE {
        soit x : chaîne = arg;
        write(0, pointeur de x, taille de x);
    }
    sinon si id de info == TYPE_STRUCTURE {
        soit info_arg = transtype(info : *InfoTypeStructure); 
        
        ecrie = sprintf(ptr_tmp, "%s {", pointeur de nom de info_arg);
        write(0, ptr_tmp, transtype(ecrie : z64));

        soit membres = membres de info_arg;

        dyn virgule = '\0';

        pour membre dans membres {
            soit pointeur = pointeur de nom de membre;
            soit decalage = decalage de membre;
            soit id = id de membre;
            
            ecrie = sprintf(ptr_tmp, "%c", virgule);
            write(0, ptr_tmp, transtype(ecrie : z64));

            ecrie = sprintf(ptr_tmp, " %s = ", pointeur);
            write(0, ptr_tmp, transtype(ecrie : z64));
            
            imprime_valeur_membre(pointeur de arg + decalage, id);
            virgule = ',';
        }

        ecrie = sprintf(ptr_tmp, " %c", '}');
        write(0, ptr_tmp, transtype(ecrie : z64));
        ecrie = 0;
    }
    sinon si id de info == TYPE_POINTEUR {
        # Ne pas oublier qu'il y a un niveau d'indirection.
        soit x = transtype(pointeur de arg : **z8);
        soit x0 = mémoire(x);
        ecrie = sprintf(ptr_tmp, "%p", x0);
    }
    sinon si id de info == TYPE_FONCTION {
        # À FAIRE
    }
    sinon si id de info == TYPE_EINI {
        # À FAIRE
    }
    sinon si id de info == TYPE_RIEN {
        # À FAIRE
    }
    sinon si id de info == TYPE_TABLEAU {
        # À FAIRE : la coulisse C 
        soit x : []z8 = mémoire(transtype(pointeur de arg : *[]z8));
        ecrie = sprintf(ptr_tmp, "tableau { ptr = %p, taille = %d }", pointeur de x, taille de x);
    }
    
    si ecrie > 0 {
        write(0, ptr_tmp, transtype(ecrie : z64));
    }
}

fonction imprime(args : ...eini) : rien
{
    pour arg dans args {
        imprime_arg(arg);
    }
}
