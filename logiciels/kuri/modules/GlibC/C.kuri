// définitions des interfaces de la bibliothèques C pour GNU/Linux

#inclus "arpa/inet.h"
#inclus "dirent.h"
#inclus "fcntl.h"
#inclus "netdb.h"
#inclus "stdio.h"
#inclus "sys/stat.h"
#inclus "sys/time.h"
#inclus "sys/wait.h"
#inclus "time.h"
#inclus "unistd.h"

//###############################################################################

// Valeur des descripteurs fichiers pour les flux standards.
std_out := 0
std_err := 1
std_log := 2

sprintf :: fonc externe (tmp : *z8, fmt : *z8, args : ...) -> z32

//###############################################################################

// ATTENTION : à tenir synchronisée avec celle de la bibliothèque C.
timeval :: struct externe  {
	tv_sec : z64
	tv_usec : z64
}

// ATTENTION : à tenir synchronisée avec celle de la bibliothèque C.
// À FAIRE : déprécié
timezone :: struct externe  {
	tz_minuteswest : z64 // Minutes à l'ouest de GMT
	tz_dsttime : z64 // Nonzéro si DST est en effet
}

gettimeofday :: fonc externe (val_temps : *rien, zone_temps : *rien) -> rien

// @Interface : z64 ici est time_t (pour linux en tout cas)
time :: fonc externe (tloc: *z64) -> z64

/* ISO C `broken-down time' structure.  */
// @Interface : doit être synchronisée avec struct_tm.h
tm :: struct externe {
    tm_sec: z32      /* Seconds.      [0-60] (1 leap second) */
    tm_min: z32      /* Minutes.      [0-59] */
    tm_hour: z32     /* Hours.        [0-23] */
    tm_mday: z32     /* Day.          [1-31] */
    tm_mon: z32      /* Month.        [0-11] */
    tm_year: z32     /* Year - 1900. */
    tm_wday: z32     /* Day of week.  [0-6] */
    tm_yday: z32     /* Days in year. [0-365] */
    tm_isdst: z32    /* DST.          [-1/0/1] */
    tm_gmtoff : z64; /* Seconds east of UTC.  */
    tm_zone : *z8;   /* Timezone abbreviation.  */
}

localtime :: fonc externe (tloc: *z64) -> *tm

//###############################################################################

open :: fonc externe (chemin : *z8, drapeaux : z32, args : ...) -> z32
close :: fonc externe (fd : z32) -> z32
read :: fonc externe (fd : z32, tampon : *z8, taille : n64) -> z64
write :: fonc externe (fd : z32, tampon : *z8, taille : z64) -> z32
stat :: fonc externe (chemin : *z8, buf : *rien) -> z32

getcwd :: fonc externe (ptr : *z8, taille : z64) -> rien
chdir :: fonc externe (ptr : *z8) -> rien

abort :: fonc externe () -> rien
getuid :: fonc externe () -> z32

rename :: fonc externe (orig : *z8, dest : *z8) -> z32
remove :: fonc externe (chemin : *z8) -> z32

// Ceci sont des macros
S_ISREG :: fonc externe (mode : n32) -> bool
S_ISDIR :: fonc externe (mode : n32) -> bool
S_IFSOCK :: fonc externe (mode : n32) -> bool
S_IFLNK :: fonc externe (mode : n32) -> bool
S_IFBLK :: fonc externe (mode : n32) -> bool
S_IFCHR :: fonc externe (mode : n32) -> bool
S_IFIFO :: fonc externe (mode : n32) -> bool

// Version 64-bit de la structure 'stat' de "sys/stat.h"
stat :: struct externe  {
    st_dev : n64         // ID of device containing file
	st_ino : n64         // inode number
	st_nlink : n64     // number of hard links
	st_mode : n32       // protection
	st_uid : n32         // user ID of owner
	st_gid : n32         // group ID of owner
	__pad0 : n32         // padding pour la version 64-bit
	st_rdev : n64        // device ID (if special file)
	st_size : z64        // total size, in bytes
	st_blksize : z64 // blocksize for file system I/O
	st_blocks : z64
	st_atime : z64      // time of last access
	st_mtime : z64      // time of last modification
	st_ctime : z64      // time of last status change
}

DIR :: struct externe

dirent :: struct externe  {
    d_ino : n64
    d_off : n64
    d_reclen : n16
    d_type : n8
    d_name : *z8
}

// duplique un énum
_DT_UNKNOWN := 0
_DT_FIFO := 1
_DT_CHR := 2
_DT_DIR := 4
_DT_BLK := 6
_DT_REG := 8
_DT_LNK := 10
_DT_SOCK := 12
_DT_WHT := 14

// open/fnctl
MODE_ACCÈS       :=      0o003
LECTURE_SEULE    :=        0o0
ÉCRITURE_SEULE   :=        0o1
LECTURE_ÉCRITURE :=        0o2
CREATION         :=      0o100
EXCLUSION        :=      0o200
NOCTTY           :=      0o400
TRONCAGE         :=     0o1000
APPEND           :=     0o2000
NONBLOCK         :=     0o4000
NDELAY           :=     0o4000
SYNC             :=  0o4010000
FSYNC            :=  0o4010000
ASYNC            :=    0o20000
LARGEFILE        :=   0o100000
DIRECTORY	     :=   0o200000
NOFOLLOW	     :=   0o400000
CLOEXEC          :=  0o2000000
DIRECT	         :=    0o40000
NOATIME          :=  0o1000000
PATH             := 0o10000000
DSYNC	         :=    0o10000
// À FAIRE : les expressions utilisent des variables temporaires lors de la
// génération du code, ce qui n'est pas possible pour les variables globales ou
// encore les énum. L'expression devrait être (0o20000000 | 0o200000)
TMPFILE          := 0o20200000

_O_NONBLOCK := 0o04000

_F_DUPFD := 0	/* Duplicate file descriptor.  */
_F_GETFD := 1	/* Get file descriptor flags.  */
_F_SETFD := 2	/* Set file descriptor flags.  */
_F_GETFL := 3	/* Get file status flags.  */
_F_SETFL := 4	/* Set file status flags.  */

fcntl :: fonc externe (fd: z32, cmd: z32, args: ...) -> z32

opendir :: fonc externe (chemin : *z8) -> *DIR
closedir :: fonc externe (d : *DIR) -> z32
readdir :: fonc externe (d : *DIR) -> *dirent

//###############################################################################

_PF_INET := 2
_AF_INET := 2
_SOCK_STREAM := 1
_WNOHANG := 1
_INADDR_ANY := transtype(0 : n32)

hostent :: struct externe  {
    h_name : *z8
    h_aliases : **z8
    h_addrtype : z32
    h_length : z32
    h_addr_list : **z8
}

in_addr :: struct externe  {
    s_addr : n32
}

sockaddr :: struct externe  {
    sa_family : n16
    sa_data : [14]z8
}

sockaddr_in :: struct externe  {
    sin_family : n16
    sin_port : n16
    sin_addr : in_addr
    sin_zero : [8]n8
}

gethostbyname :: fonc externe (arg : *z8) -> *hostent

socket :: fonc externe (a : z32, b : z32, c : z32) -> z32

_SOL_SOCKET := 1
_SO_REUSEADDR := 2

setsockopt :: fonc externe (sockfd: z32, level: z32, optname: z32, optval: *rien, optlen: n64) -> z32

htonl :: fonc externe (hostlong: n32) -> n32
htons :: fonc externe (hostshort: n16) -> n16
ntohl :: fonc externe (netlong: n32) -> n32
ntohs :: fonc externe (netshort: n16) -> n16

connect :: fonc externe (prise : z32, addr : *sockaddr, taille : z64) -> z32

recv :: fonc externe (prise : z32, tampon : *z8, taille : n64, flags : z32) -> z64
send :: fonc externe (prise : z32, tampon : *rien, taille : n64, flags : z32) -> z64
bind :: fonc externe (prise : z32, addr : *sockaddr, taille : n64) -> z32
listen :: fonc externe (prise : z32, connexions : z32) -> z32
accept :: fonc externe (prise : z32, addr : *sockaddr, taille : *n32) -> z32
perror :: fonc externe (ptr : *z8) -> rien
fork :: fonc externe () -> z32
exit :: fonc externe (id : z32) -> rien
waitpid :: fonc externe (id : z32, ptr : *z32, options : z32) -> z32
send :: fonc externe (prise : z32, pointeur : *z8, taille : z64, options : z32) -> z32
inet_ntoa :: fonc externe (addr : in_addr) -> *z8

// -------------------------------------

printf :: fonc externe (fmt: *z8, args: ...) -> z32
sprintf :: fonc externe (buf: *z8, fmt: *z8, s: z32) -> rien

memset :: fonc externe (ptr: *rien, valeur: z32, taille: n64) -> rien
memcpy :: fonc externe (ptr: *rien, src: *rien, taille: n64) -> rien

// -------------------------------------

FILE :: struct externe
fopen :: fonc externe (__filename : *z8, __modes : *z8) -> *FILE
fclose :: fonc externe (__file : *FILE) -> z32

// -------------------------------------

_SIGINT := 2

signal :: fonc externe (numéro_signal: z32, rappel: #nulctx fonc(z32)(rien)) -> rien
